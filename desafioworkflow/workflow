# üöÄ Desafio DIO: Processamento em Larga Escala com AWS Step Functions

Este reposit√≥rio documenta a implementa√ß√£o do laborat√≥rio "Consolidando Workflows Automatizados com AWS Step Functions" da [Digital Innovation One (DIO)](https://dio.me/).

O projeto focou em um caso de uso avan√ßado e de alta performance: **o processamento paralelo de um grande volume de dados (arquivos) armazenados em um bucket Amazon S3, utilizando o estado `Map` no modo distribu√≠do.**

## üìå Sum√°rio

* [O que √© AWS Step Functions?](#-o-que-√©-aws-step-functions)
* [Tecnologias Utilizadas](#-tecnologias-utilizadas)
* [Conceitos-Chave Aplicados](#-conceitos-chave-aplicados)
* [Descri√ß√£o do Workflow do Laborat√≥rio](#-descri√ß√£o-do-workflow-do-laborat√≥rio)
* [Arquitetura Visual do Workflow](#-arquitetura-visual-do-workflow)
* [Defini√ß√£o da M√°quina de Estado (ASL)](#-defini√ß√£o-da-m√°quina-de-estado-asl)
* [Resultados e Insights](#-resultados-e-insights)
* [Conclus√£o](#-conclus√£o)

## üí° O que √© AWS Step Functions?

O **AWS Step Functions** √© um servi√ßo de orquestra√ß√£o *serverless* que permite coordenar m√∫ltiplos servi√ßos da AWS em fluxos de trabalho visuais e resilientes. Ele √© baseado no conceito de **M√°quinas de Estado** e utiliza uma linguagem declarativa baseada em JSON chamada **Amazon States Language (ASL)**.

Em vez de acoplar servi√ßos (como fun√ß√µes Lambda chamando outras fun√ß√µes Lambda), o Step Functions atua como um "maestro" central. Ele gerencia o fluxo, o tratamento de erros, as retentativas e a l√≥gica condicional, permitindo que cada componente (microsservi√ßo) foque apenas na sua tarefa.

## üõ†Ô∏è Tecnologias Utilizadas

Para a constru√ß√£o deste projeto, os seguintes servi√ßos da AWS foram essenciais:

* **AWS Step Functions:** Para a defini√ß√£o, orquestra√ß√£o e monitoramento do workflow paralelo.
* **Amazon S3 (Simple Storage Service):** Atuou como a fonte de dados (`ItemReader`), armazenando os milhares de arquivos que precisavam ser processados.
* **AWS Lambda:** Foi o nosso processador (`ItemProcessor`). Cada execu√ß√£o paralela do workflow invocou uma fun√ß√£o Lambda para realizar o trabalho em um arquivo individual.
* **AWS IAM (Identity and Access Management):** Fundamental para conceder as permiss√µes corretas para que o Step Functions pudesse ler do bucket S3 e invocar as fun√ß√µes Lambda.

## üß† Conceitos-Chave Aplicados

Este laborat√≥rio foi focado em conceitos avan√ßados de processamento de dados. Os principais aprendizados foram:

1.  **Estado `Map` (Modo Distribu√≠do):** Este foi o cora√ß√£o do projeto. Diferente do modo *inline*, o modo distribu√≠do √© otimizado para processar conjuntos de dados em escala de petabytes. Ele l√™ os itens diretamente de uma fonte (como o S3) e inicia milhares de "execu√ß√µes-filhas" em paralelo.
2.  **`ItemReader`:** Configuramos o estado `Map` para ler os dados de origem diretamente de um bucket S3, especificando qual bucket e prefixo continham os arquivos a serem processados.
3.  **`ItemProcessor`:** Definimos o "trabalho" a ser feito para cada item. No nosso caso, o processador era uma m√°quina de estado interna simples que tinha como √∫nica tarefa (`Task`) invocar uma fun√ß√£o Lambda.
4.  **Alta Concorr√™ncia (`MaxConcurrency`):** Aprendemos a controlar o n√≠vel de paralelismo. O Step Functions pode lan√ßar at√© 10.000 execu√ß√µes paralelas simultaneamente, permitindo um processamento massivo em muito pouco tempo.
5.  **Desacoplamento:** Refor√ßamos o conceito de que a fun√ß√£o Lambda n√£o precisa saber *quantos* arquivos existem ou *quem* a chamou. Ela apenas recebe um evento (contendo a informa√ß√£o do arquivo S3) e executa sua l√≥gica de processamento.

## üîß Descri√ß√£o do Workflow do Laborat√≥rio

O objetivo do workflow implementado foi **simular um processo de ETL (Extra√ß√£o, Transforma√ß√£o e Carga) em massa**. O fluxo de trabalho foi projetado para "varrer" um bucket S3, encontrar todos os arquivos .json ou .csv, e aplicar uma l√≥gica de valida√ß√£o/transforma√ß√£o em cada um deles de forma independente e paralela.

O processo funciona da seguinte forma:

1.  **In√≠cio:** A m√°quina de estado √© iniciada.
2.  **Estado `Map` (Distribu√≠do):** Este √∫nico estado assume o controle.
    * **Leitura (Read):** O `ItemReader` √© acionado e come√ßa a listar os objetos no bucket S3 `meu-bucket-de-entrada-dio`.
    * **Processamento (Process):** Para cada arquivo encontrado, o Step Functions inicia uma nova execu√ß√£o-filha paralela.
    * **Execu√ß√£o-Filha:** Cada uma dessas execu√ß√µes invoca a fun√ß√£o Lambda `dio-lab-processador-de-arquivos`. Esta fun√ß√£o (simulada) poderia estar validando o schema de um JSON, limpando dados de um CSV, ou gerando metadados.
3.  **Aguardar Conclus√£o:** A execu√ß√£o principal do Step Functions aguarda at√© que **todas** as milhares de execu√ß√µes-filhas tenham sido conclu√≠das (seja com sucesso ou falha).
4.  **Fim:** O workflow √© marcado como conclu√≠do.

## üìä Arquitetura Visual do Workflow

Abaixo est√° a visualiza√ß√£o gr√°fica da m√°quina de estado, conforme gerada pelo console do AWS Step Functions. Ela √© elegantemente simples, pois toda a complexidade do paralelismo √© abstra√≠da pelo √∫nico estado `Map`.

*(**SUA TAREFA:** Tire uma captura de tela do diagrama do workflow, como a que aparece no seu v√≠deo, salve na pasta `/images` do seu reposit√≥rio e substitua o link abaixo.)*

![Visualiza√ß√£o do Workflow com Map Distribu√≠do](images/diagrama-workflow-map.png)

## üìë Defini√ß√£o da M√°quina de Estado (ASL)

Este √© o c√≥digo-fonte (JSON) da nossa m√°quina de estado. A ASL define o `Map` Distribu√≠do, apontando para o S3 como leitor (`ItemReader`) e para a fun√ß√£o Lambda como processador (`ItemProcessor`).

```json
{
  "Comment": "Desafio DIO: Processamento em massa de arquivos S3 com Map Distribu√≠do",
  "StartAt": "Processar Arquivos do S3",
  "States": {
    "Processar Arquivos do S3": {
      "Type": "Map",
      "MaxConcurrency": 1000,
      "ItemReader": {
        "Resource": "arn:aws:states:::s3:listObjectsV2",
        "Parameters": {
          "Bucket": "meu-bucket-de-entrada-dio"
        }
      },
      "ItemProcessor": {
        "ProcessorConfig": {
          "Mode": "DISTRIBUTED",
          "ExecutionType": "STANDARD"
        },
        "StartAt": "Processar Arquivo Individual",
        "States": {
          "Processar Arquivo Individual": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:us-east-1:123456789012:function:dio-lab-processador-de-arquivos",
            "End": true,
            "Retry": [
              {
                "ErrorEquals": [
                  "Lambda.ServiceException",
                  "Lambda.TooManyRequestsException"
                ],
                "IntervalSeconds": 2,
                "MaxAttempts": 3,
                "BackoffRate": 2
              }
            ],
            "Catch": [
              {
                "ErrorEquals": [
                  "States.ALL"
                ],
                "Next": "FalhaNoProcessamento"
              }
            ]
          },
          "FalhaNoProcessamento": {
            "Type": "Fail",
            "Cause": "Falha ao processar o arquivo"
          }
        }
      },
      "End": true
    }
  }
}
